<!DOCTYPE HTML>
<html>
  <head>
    <title>Journal entry</title>
    <meta charset="UTF-8">
    <script src="js/jquery-3.1.0.min.js" type="text/javascript"></script>
    <script type="text/javascript">
$(document).ready(function () {
  var displayEntries = function(d) {
    var index = d.length
    while(index > 0){
      --index
      $('#entries pre').append(
        d[index].timestamp + ' ' +
        d[index].title + ' ' +
        d[index].content + '\r\n')
    }
  }
  var formToJSON = function (form) {
    var json = {}
    $.each($(form).serializeArray(), function (key, elm) {
      json[elm.name] = elm.value
    })
    return json
  }

  var eci // required
  if(location.hash){
    eci = location.hash.substring(1)
  }else{
    eci = prompt('ECI')
  }
  $.getJSON('/sky/cloud/'+eci+'/io.picolabs.visual_params/dname',function(d){
    $('h1').html(d)
    document.title = d
    $.getJSON('/sky/cloud/'+eci+'/io.picolabs.journal/getEntry',displayEntries)
    $('input.js-initial-focus:first').focus()
    $('body').find('.js-ajax-form').submit(function (e) {
      var number = this.title.value
      e.preventDefault()
      var url = '/sky/event/'+eci+'/reading/journal/new_entry'
      $.getJSON(url, formToJSON(this), function () {
        alert('Recorded this: '+number)
        location.reload()
      })
    })
  })
  .fail(function(e){
    $('body').html('<div>need a valid ECI</div>')
  })
})
    </script>
    <style type="text/css">
label {
  display: inline-block;
  width: 8em;
  text-align: right;
  vertical-align: top;
  margin-bottom: 5px;
}
    </style>
  </head>
  <body>
    <h1>Journal entry</h1>
    <form class="js-ajax-form">
      <label>Reading:</label>
      <input class="js-initial-focus" name="title" type="number" min="0" max="999" required="">
      <br/>
      <label>Comment:</label>
      <textarea rows="2" cols="80" name="content"></textarea>
      <br/>
      <label></label>
      <button type="submit">Submit</button>
    </form>
    <div id="entries"><pre></pre></div>
  </body>
</html>

